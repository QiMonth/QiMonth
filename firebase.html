<!DOCTYPE html>
<html lang="en">

<head>
    <meta charset="UTF-8">
    <title>Document</title>
    <meta name="viewport" content="width=device-width, initial-scale=1">
    <link rel="stylesheet" href="https://maxcdn.bootstrapcdn.com/bootstrap/3.3.7/css/bootstrap.min.css">
    <script src="https://ajax.googleapis.com/ajax/libs/jquery/3.1.1/jquery.min.js"></script>
    <script src="https://maxcdn.bootstrapcdn.com/bootstrap/3.3.7/js/bootstrap.min.js"></script>
    <link rel="manifest" href="/manifest.json">
</head>

<body>
    <div class="container">
        <div class="row">
            <div class="col-md-8 col-md-offset-2">
                <h1 class="text-center"><u>Firebase Cloud Messaging Demo</u></h2>
                <p>&nbsp;</p>
                <h2>Instructions</h2>
                <p>Allow The Push Message Notification Message By The Browser. Then Copy and Paste Id you obtained in text box by visiting same url in 
                another browser after you close this TAB not this browser. The Push Notification will not work if you are in same Tab of this domain that is why you need to open another browser.
                <br><br><b>You Can Allow the Push Notification Message Freely Since I am not storing any of Your client ID in this demo APP.</b></p>
                
                <p>You Client ID Will Be Listed Below</p>
                <div class="well" id="msg">Your Client ID : </div>
                <div class="well" id="newmsg">New ToKen : </div>
                <p>&nbsp;</p>
                <form action="curl.php" method="POST">
                  <div class="form-group">
                    <label for="cid">Enter The Client ID of Other Browser</label>
                    <input type="test" class="form-control" name="cid" value="">
                  </div>
                  <button type="submit" class="btn btn-primary btn-block">SUBMIT</button>
                </form>
            </div>
        </div>
        <p>&nbsp;</p>
    </div>
    <script src="https://www.gstatic.com/firebasejs/4.5.1/firebase.js"></script>
    <script>
    var config = {
        apiKey: "AIzaSyDHZTrl00SP05ao8jsj1E80gFV2LC2x-fQ",
        authDomain: "gcall-4a0f8.firebaseapp.com",
        databaseURL: "https://gcall-4a0f8.firebaseio.com",
        projectId: "gcall-4a0f8",
        storageBucket: "gcall-4a0f8.appspot.com",
        messagingSenderId: "851484560417"
    };
    firebase.initializeApp(config);

    var messaging = firebase.messaging();

    // 申请接收通知的权限
    messaging.requestPermission().then(function() {
        console.log('Notification permission granted.');
        messaging.getToken()
            .then(function(currentToken) {
                if (currentToken) {
                    sendTokenToServer(currentToken); 
                    $('#msg').html(token); 
                } else {
                    // Show permission request.
                    console.log('No Instance ID token available. Request permission to generate one.');
                    // Show permission UI. 
                    setTokenSentToServer(false);
                }
            })
            .catch(function(err) {
                console.log('An error occurred while retrieving token. ', err); 
                setTokenSentToServer(false);
            }); 
    })["catch"](function(err) {
        console.log('Unable to get permission to notify.', err);
        setTokenSentToServer(false);
    });

    // 接收数据
    messaging.onMessage(function(payload) {
        console.log('onMessage', payload);
    });

    // [START 监控令牌刷新]
    messaging.onTokenRefresh(function() {
        console.log('监控令牌刷新');
        // 检索当前的注册令牌
        messaging.getToken()
            .then(function(refreshedToken) {
                console.log('获取token', refreshedToken);
                // Indicate that the new Instance ID token has not yet been sent to the
                // app server.
                setTokenSentToServer(false);
                // Send Instance ID token to app server.
                sendTokenToServer(refreshedToken); 
                // [START_EXCLUDE]
                // Display new Instance ID token and clear UI of all previous messages. 
                // [END_EXCLUDE]
            })
            .catch(function(err) {
                console.log('Unable to retrieve refreshed token ', err); 
            });
    });
    // [END refresh_token]

    // 把token发送给服务器;
    function sendTokenToServer(currentToken) {
        if (!isTokenSentToServer()) {
            console.log('Sending token to server...');
            // TODO(developer): Send the current token to your server.
            setTokenSentToServer(true);
            $('#newmsg').html(currentToken);
        } else {
            console.log('Token already sent to server so won\'t send it again ' +
                'unless it changes');
        }

    }

    function isTokenSentToServer() {
        return window.localStorage.getItem('sentToServer') == 1;
    }

    // 检查是否本地存储token;
    function setTokenSentToServer(sent) {
        window.localStorage.setItem('sentToServer', sent ? 1 : 0);
    }


    </script>
</body>
</html>
